{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bias Detector Diagnostics</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body class="nb-body">
  <nav class="navbar navbar-expand-lg nb-nav">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="{% url 'dashboard' %}{% if batch_id %}?batch_id={{ batch_id|urlencode }}{% endif %}">
        <span class="brand-dot"></span> Bias Detector
      </a>
      <div class="nb-nav-links ms-3 d-none d-md-flex">
        <a class="nav-link-nb {% if page == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}{% if batch_id %}?batch_id={{ batch_id|urlencode }}{% endif %}">Overview</a>
        <a class="nav-link-nb {% if page == 'diagnostics' %}active{% endif %}" href="{% url 'diagnostics' %}{% if batch_id %}?batch_id={{ batch_id|urlencode }}{% endif %}">Diagnostics</a>
        <a class="nav-link-nb {% if page == 'simulator' %}active{% endif %}" href="{% url 'simulator' %}{% if batch_id %}?batch_id={{ batch_id|urlencode }}{% endif %}">Simulator</a>
      </div>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <span class="nav-batch">Batch: {{ batch_id|default:"-" }}</span>
        <a class="btn btn-sm btn-nb-secondary" href="/api/analyze/?batch_id={{ batch_id|urlencode }}" target="_blank">
          API <i class="bi bi-box-arrow-up-right ms-1"></i>
        </a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    {% if empty %}
      <div class="card nb-card">
        <div class="card-body p-4 text-center">
          <h1 class="section-title mb-2">Diagnostics</h1>
          <p class="text-muted mb-0">Upload a dataset on the Overview page to unlock diagnostics.</p>
        </div>
      </div>
    {% else %}
      <section class="nb-hero nb-hero-compact mb-4">
        <div class="hero-kicker">Diagnostics Lab</div>
        <h1 class="hero-title">Behavioral Diagnostics Deep Dive</h1>
        <p class="hero-subtitle">Quality controls, market-timing structure and bias signal internals for batch {{ batch_id }}.</p>
      </section>

      <div class="row g-4 mb-4">
        <div class="col-lg-5">
          <div class="card nb-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="section-title mb-0">Data Quality</h2>
                <span class="section-meta">Integrity checks</span>
              </div>
              <div class="quality-list">
                <div class="quality-item"><span>Duplicate rows</span><b>{{ data_quality.duplicate_count }}</b></div>
                <div class="quality-item"><span>Large time gaps</span><b>{{ data_quality.large_gap_count }}</b></div>
                <div class="quality-item"><span>Median gap (min)</span><b>{{ data_quality.median_gap_min|floatformat:2 }}</b></div>
                <div class="quality-item"><span>Gap threshold (min)</span><b>{{ data_quality.gap_threshold_min|floatformat:2 }}</b></div>
                <div class="quality-item"><span>Non-positive balances</span><b>{{ data_quality.non_positive_balance_count }}</b></div>
                <div class="quality-item"><span>Flat balance rate</span><b>{{ data_quality.flat_balance_rate|floatformat:2 }}%</b></div>
              </div>
              <p class="small text-muted mt-3 mb-0">Use this panel to validate import quality before interpreting bias scores.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card nb-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="section-title mb-0">Execution Cadence</h2>
                <span class="section-meta">Per hour timeline</span>
              </div>
              <div class="viz-frame-half mt-3">
                <canvas id="diagHourlyChart"></canvas>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="small text-muted">Session window: {{ start_display }} - {{ end_display }}</div>
                <div class="small text-muted">{{ n_trades }} trades</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-lg-8">
          <div class="card nb-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="section-title mb-0">Trading Heatmap</h2>
                <span class="section-meta">Day of week x hour</span>
              </div>
              <div class="heatmap-wrap table-scroll-half">
                <table class="heat-table">
                  <thead>
                    <tr>
                      <th>Day</th>
                      {% for h in hour_labels_24 %}
                        <th>{{ h }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in heatmap_rows %}
                      <tr>
                        <td class="day-label">{{ row.day }}</td>
                        {% for v in row.values %}
                          <td class="heat-cell" data-value="{{ v }}">{{ v }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card nb-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="section-title mb-0">Gap Structure</h2>
                <span class="section-meta">Inter-trade delay</span>
              </div>
              <div class="viz-frame-half mt-3">
                <canvas id="diagGapChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-lg-6">
          <div class="card nb-card h-100">
            <div class="card-body">
              <h2 class="section-title mb-2">Best Trading Hours</h2>
              <p class="small text-muted">Filtered with at least {{ min_trades_threshold }} trades.</p>
              <div class="hour-list">
                {% for row in best_hours %}
                  <div class="hour-item good">
                    <div>
                      <div class="fw-semibold">{{ row.hour }}</div>
                      <div class="small text-muted">Trades: {{ row.trades }} | Avg P/L: {{ row.avg_pnl|floatformat:2 }}</div>
                    </div>
                    <div class="hour-badge">{{ row.win_rate|floatformat:1 }}%</div>
                  </div>
                {% empty %}
                  <div class="text-muted small">Not enough data.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card nb-card h-100">
            <div class="card-body">
              <h2 class="section-title mb-2">Weakest Trading Hours</h2>
              <p class="small text-muted">Filtered with at least {{ min_trades_threshold }} trades.</p>
              <div class="hour-list">
                {% for row in worst_hours %}
                  <div class="hour-item bad">
                    <div>
                      <div class="fw-semibold">{{ row.hour }}</div>
                      <div class="small text-muted">Trades: {{ row.trades }} | Avg P/L: {{ row.avg_pnl|floatformat:2 }}</div>
                    </div>
                    <div class="hour-badge">{{ row.win_rate|floatformat:1 }}%</div>
                  </div>
                {% empty %}
                  <div class="text-muted small">Not enough data.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-12">
          <div class="card nb-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="section-title mb-0">Bias Signal Drilldown</h2>
                <span class="section-meta">Raw indicators behind each score</span>
              </div>
              <div class="row g-3">
                {% for card in bias_signal_cards %}
                <div class="col-xl-4 col-md-6">
                  <div class="diagnostic-bias-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="fw-semibold"><i class="bi {{ card.icon }} me-1"></i>{{ card.label }}</div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="state-badge state-{{ card.level|lower }}">
                          {% if card.level == "LOW" %}Controlled{% elif card.level == "MEDIUM" %}Moderate{% else %}Elevated{% endif %}
                        </span>
                        <span class="bias-score">{{ card.score|floatformat:1 }}</span>
                      </div>
                    </div>
                    <div class="signal-table">
                      {% for signal in card.signals %}
                      <div class="signal-row">
                        <span class="signal-metric">{{ signal.metric|title }}</span>
                        <b>{{ signal.value }}</b>
                      </div>
                      {% empty %}
                      <div class="small text-muted">No signal details available.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </main>

  {% if not empty %}
    {{ heatmap_max|json_script:"heatmapMax" }}
    {{ diag_hourly_labels|json_script:"diagHourlyLabels" }}
    {{ diag_hourly_values|json_script:"diagHourlyValues" }}
    {{ diag_gap_labels|json_script:"diagGapLabels" }}
    {{ diag_gap_values|json_script:"diagGapValues" }}
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    function elJson(id){ return JSON.parse(document.getElementById(id).textContent); }

    {% if not empty %}
    const heatmapMax = elJson("heatmapMax") || 1;
    document.querySelectorAll(".heat-cell").forEach((cell) => {
      const value = Number.parseFloat(cell.dataset.value || "0") || 0;
      const ratio = Math.max(0, Math.min(1, value / heatmapMax));
      const alpha = 0.10 + ratio * 0.80;
      cell.style.backgroundColor = `rgba(225, 37, 27, ${alpha.toFixed(3)})`;
      cell.style.color = ratio > 0.55 ? "#fff" : "#111";
    });

    const hourLabelsRaw = elJson("diagHourlyLabels");
    const hourValues = elJson("diagHourlyValues");
    const gapLabels = elJson("diagGapLabels");
    const gapValues = elJson("diagGapValues");

    const fmtDate = new Intl.DateTimeFormat("fr-FR", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    });
    const hourLabels = hourLabelsRaw.map((v) => {
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return v;
      return fmtDate.format(d);
    });

    const colors = {
      red: "#E1251B",
      dark: "#111111",
      axis: "#6B7280",
      grid: "rgba(17, 17, 17, 0.08)",
      tooltipBg: "#111111",
      tooltipBorder: "#2B2B2B",
    };

    const commonOpts = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: colors.tooltipBg,
          borderColor: colors.tooltipBorder,
          borderWidth: 1,
          titleColor: "#F9FAFB",
          bodyColor: "#F9FAFB",
          padding: 10,
          displayColors: false,
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: colors.axis, maxTicksLimit: 8 } },
        y: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.axis, maxTicksLimit: 6 } }
      }
    };

    new Chart(document.getElementById("diagHourlyChart"), {
      type: "line",
      data: {
        labels: hourLabels,
        datasets: [{
          label: "Trades per hour",
          data: hourValues,
          borderColor: colors.dark,
          backgroundColor: "rgba(17, 17, 17, 0.08)",
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
          fill: true,
        }]
      },
      options: commonOpts
    });

    new Chart(document.getElementById("diagGapChart"), {
      type: "bar",
      data: {
        labels: gapLabels,
        datasets: [{
          data: gapValues,
          backgroundColor: ["rgba(17,17,17,0.82)", "rgba(80,80,80,0.80)", "rgba(130,130,130,0.80)", "rgba(225,37,27,0.88)"],
          borderRadius: 5,
        }]
      },
      options: {
        ...commonOpts,
        scales: {
          x: { grid: { display: false }, ticks: { color: colors.axis } },
          y: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.axis, precision: 0 } }
        }
      }
    });
    {% endif %}
  </script>
</body>
</html>
